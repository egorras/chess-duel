name: Deploy Lichellange Bot

on:
  push:
    branches:
      - main
    paths:
      - 'lichellange-bot/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Set deployment path
        id: set_path
        run: |
          if [ -z "${{ secrets.VM_DEPLOY_PATH }}" ]; then
            echo "DEPLOY_PATH=/home/${{ secrets.VM_USER }}/lichellange-bot" >> $GITHUB_ENV
          else
            echo "DEPLOY_PATH=${{ secrets.VM_DEPLOY_PATH }}" >> $GITHUB_ENV
          fi

      - name: Create deployment directory
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "mkdir -p $DEPLOY_PATH"

      - name: Copy files to VM
        run: |
          scp -i ~/.ssh/id_rsa -r lichellange-bot/* \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:$DEPLOY_PATH/

      - name: Deploy on VM
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << EOF
            cd $DEPLOY_PATH
            
            # Ensure Docker is running
            sudo systemctl start docker || true
            
            # Stop existing container if running
            docker-compose down || true
            
            # Build and start the bot
            docker-compose up -d --build
            
            # Show logs
            docker-compose logs --tail=50
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "cd $DEPLOY_PATH && docker-compose ps"
